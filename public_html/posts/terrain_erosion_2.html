<html>
<head>
	<link rel="stylesheet" type="text/css" href="../style.css">
	<title>Axel Paris</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta http-equiv="Content-type" content="text/html; charset=utf-8"/> 
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
	<link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>  
  <body>
	<br>
	<center>
		<a href="../../index.html" style="text-decoration: none;font-size:1.2em"><b>Axel Paris - PhD Student in Computer Graphics</b>
		<br>
		<hr style="width:20em;">
		</a>
		<a class="aUnderlined" href="../../index.html">Home</a> &nbsp;
		<a class="aUnderlined" href="../publications.html">Publications</a> &nbsp;
		<a class="aUnderlined" href="../cv.html">Resume</a> &nbsp;
		<a class="aUnderlined" href="mailto:axel.paris69@gmail.com">Email</a> &nbsp;
		<a class="aUnderlined" href="https://twitter.com/Axel_Paris">Twitter</a>
		<br>
	</center>
	<br>
	<div>
	<h2>Terrain Erosion on the GPU #2</h2>
	February 14, 2020.
	</div>
	<hr>
	<h3> Introduction </h3>
	In my previous post on thermal erosion, I tried to implement the naive, straightforward version of the algorithm which
	can be summarized as this: for every vertex v, check if v is unstable in regards to its neighbours. If so, distribute
	a certain amount of material to some of the downwards neighbours.
	<br>
	The problem with this approach when in a massively parallel context is that we need to write to neighboring cells, and
	this leads to atomic operations which are slow. For several algorithm, what often works is to reverse the thinking: instead
	of trying to distribute to neighboring cells, check what I will be receiving from them. This can be done with readonly
	operations which don't lead to race conditions.
	<br>
	In fact, for thermal erosion it can be done pretty easily. Here is the revised version of the algorithm without race conditions
	or atomic operations:<br><br>
	<!-- generated by C/C++ to HTML Formatter -->
	<div style="background-color: rgb(243, 243, 243); font-family: fixed,monospace; border: 1px solid rgb(200, 200, 200); color: RGB(0, 0, 0);"><div style="margin: 10px"><span style="color: rgb(7, 55, 99); font-weight: bold">void</span> ThermalErosionStep()<br/>
	{<br/>
	&#160;&#160;&#160;&#160;<span style="color: rgb(7, 55, 99); font-weight: bold">const</span> <span style="color: rgb(7, 55, 99); font-weight: bold">float</span> tanThresholdAngle = 0.6f; <span style="color: rgb(56, 118, 29); font-style: italic">// ~33Â°</span><br/>
	&#160;&#160;&#160;&#160;<span style="color: rgb(7, 55, 99); font-weight: bold">const</span> <span style="color: rgb(7, 55, 99); font-weight: bold">float</span> cellSize = domain.Vertex(0)[0] - domain.Vertex(1)[0];<br/>
	&#160;&#160;&#160;&#160;<span style="color: rgb(7, 55, 99); font-weight: bold">for</span> (<span style="color: rgb(7, 55, 99); font-weight: bold">int</span> i = 0; i &lt; n; i++)<br/>
	&#160;&#160;&#160;&#160;{<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: rgb(7, 55, 99); font-weight: bold">for</span> (<span style="color: rgb(7, 55, 99); font-weight: bold">int</span> j = 0; j &lt; n; j++)<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: rgb(7, 55, 99); font-weight: bold">float</span> zp = GetHeight(i, j);<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: rgb(7, 55, 99); font-weight: bold">int</span> iSteepest - 1, jSteepest = -1;<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: rgb(7, 55, 99); font-weight: bold">float</span> steepestSlope = -1;<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: rgb(7, 55, 99); font-weight: bold">int</span> steepestIndex = -1;<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: rgb(7, 55, 99); font-weight: bold">for</span> (<span style="color: rgb(7, 55, 99); font-weight: bold">int</span> k = 0; k &lt; 8; k++)<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: rgb(7, 55, 99); font-weight: bold">int</span> in, jn,<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Next(i, j, k, in, jn);<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: rgb(7, 55, 99); font-weight: bold">if</span> (in &lt; 0 || in &gt;= n || jn &lt; 0 || jn &gt;= n) <span style="color: rgb(56, 118, 29); font-style: italic">// Outside terrain</span><br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: rgb(7, 55, 99); font-weight: bold">continue</span>;<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: rgb(7, 55, 99); font-weight: bold">float</span> zDiff = zp - GetHeight(in, jn);<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: rgb(7, 55, 99); font-weight: bold">if</span> (zDiff &gt; 0.0f && zDiff &gt; steepestSlope)<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;steepest = b;<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;steepestSlope = zDiff;<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;iSteepest = in;<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;jSteepest = jn;<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: rgb(7, 55, 99); font-weight: bold">if</span> (steepestSlope / (cellSize * length8[steepestIndex]) &gt; tanThresholdAngle)<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Remove(i, j, 0.1);<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Add(iSteepest, jSteepest, 0.1);<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}<br/>
	&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}<br/>
	&#160;&#160;&#160;&#160;}<br/>
	}<br/>
	</div></div>
	<!-- end of generated code -->
	<center><i>TODO</i></center><br/><br/>
	
	<h3> References </h3>

	<br>
	<hr>
 <center>